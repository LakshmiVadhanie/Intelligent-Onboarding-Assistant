name: Model Validation

on:
  push:
    branches: [ model-development-pipeline ]
    paths:
      - 'src/**'
      - 'models/**'
      - 'requirements.txt'

jobs:
  validate-models:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install numpy sentence-transformers
    
    - name: Validate embedding structure
      run: |
        python -c "
        import numpy as np
        from pathlib import Path
        import json
        
        print('Validating embedding artifacts...')
        
        # Check if embeddings exist
        emb_path = Path('models/embeddings/embeddings.npy')
        if emb_path.exists():
            embeddings = np.load(emb_path)
            print(f'✓ Embeddings found: shape {embeddings.shape}')
            
            # Validate shape
            if len(embeddings.shape) == 2:
                print(f'✓ Valid embedding dimensions')
            else:
                print('✗ Invalid embedding shape')
                exit(1)
        else:
            print('⚠ Embeddings not found (expected for fresh clone)')
        
        # Check metadata
        meta_path = Path('models/embeddings/metadata.json')
        if meta_path.exists():
            with open(meta_path) as f:
                metadata = json.load(f)
            print(f'✓ Metadata found: {len(metadata)} entries')
        
        print('Model validation complete!')
        "
    
    - name: Check model registry
      run: |
        python -c "
        from pathlib import Path
        import json
        
        print('Checking model registry...')
        
        registry_path = Path('models/registry/manifest.json')
        if registry_path.exists():
            with open(registry_path) as f:
                manifest = json.load(f)
            print(f'✓ Registry found: {len(manifest.get(\"models\", {}))} models registered')
        else:
            print('⚠ Model registry not found (will be created on registration)')
        "
    
    - name: Validation summary
      run: |
        echo "=========================================="
        echo "Model Validation Complete"
        echo "=========================================="
        echo "✓ Model artifacts validated"
        echo "✓ Registry structure checked"
        echo "=========================================="